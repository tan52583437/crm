<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘å®¢æˆ·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }
        .edit-customer-modal {
            width: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px;
        }
        .modal-header {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            background-color: #f8f9fa;
            color: #333;
        }
        .title-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }
        .auto-nav-btn {
            width: 80px;
            height: 24px;
            font-size: 11px;
        }
        .auto-nav-btn.active {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }
        .nav-btn:hover:not(.active) {
            background: #f5f5f5;
            color: #333;
        }
        .modal-close {
            cursor: pointer;
            color: #9ca3af;
            font-size: 24px;
            border: none;
            background: transparent;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .modal-close:hover {
            color: #ef4444;
            background-color: #fee2e2;
            transform: rotate(90deg);
        }
        .modal-content {
            padding: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .form-left {
            flex: 2;
            min-width: 280px;
        }
        .form-right {
            flex: 1;
            min-width: 200px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        .form-item select,
        .form-item input,
        .form-item textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #ffffff;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .name-input-wrap {
            position: relative;
        }
        .name-input-wrap input {
            padding-right: 28px;
        }
        .search-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            cursor: pointer;
        }
        .form-item textarea {
            resize: none;
            min-height: 80px;
        }
        .form-item select:focus,
        .form-item input:focus,
        .form-item textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            border-width: 2px;
        }
        input[readonly] {
            background-color: #f9f9f9;
            color: #666;
            cursor: not-allowed;
        }
        .dropdown-container {
            position: relative;
        }
        .dropdown-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            font-size: 14px;
        }
        .dropdown-trigger:hover {
            border-color: #007bff;
        }
        .dropdown-arrow {
            font-size: 12px;
            color: #666;
        }
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 4px 4px;
            display: none;
        }
        .dropdown-options.show {
            display: block;
        }
        .dropdown-option {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-option:hover {
            background: #f5f5f5;
        }
        .modal-footer {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-save {
            padding: 6px 15px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-save:hover {
            background: #0069d9;
        }
        .btn-cancel {
            padding: 6px 15px;
            background: #fff;
            color: #666;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-cancel:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="edit-customer-modal">
        <div class="modal-header">
            <div class="title-group">
                ç¼–è¾‘å®¢æˆ·
                <button class="nav-btn" id="prev-btn">â—€</button>
                <button class="nav-btn" id="next-btn">â–¶</button>
                <button class="nav-btn auto-nav-btn" id="auto-next-btn">è‡ªåŠ¨ä¸‹ä¸€æ¡</button>
            </div>
            <span class="modal-close">Ã—</span>
        </div>
        <div class="modal-content">
            <div class="form-left">
                <div class="form-item">
                    <label>å®¢æˆ·çº§åˆ«</label>
                    <div class="dropdown-container">
                        <div class="dropdown-trigger" id="level-trigger">
                            <span id="level-display">è¯·é€‰æ‹©å®¢æˆ·çº§åˆ«</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </div>
                        <div class="dropdown-options" id="level-options">
                            <div class="dropdown-option" data-value="A">Aï¼ˆä¼˜è´¨å®¢æˆ·ï¼‰</div>
                            <div class="dropdown-option" data-value="B">Bï¼ˆæ½œåŠ›å®¢æˆ·ï¼‰</div>
                            <div class="dropdown-option" data-value="C">Cï¼ˆæœªçŸ¥å®¢æˆ·ï¼‰</div>
                        </div>
                        <input type="hidden" id="customer-level" name="customer-level">
                    </div>
                </div>
                <div class="form-item">
                    <label>æ¥é€šçŠ¶æ€</label>
                    <div class="dropdown-container">
                        <div class="dropdown-trigger" id="status-trigger">
                            <span id="status-display">è¯·é€‰æ‹©æ¥é€šçŠ¶æ€</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </div>
                        <div class="dropdown-options" id="status-options">
                            <div class="dropdown-option" data-value="å·²æ¥é€š">å·²æ¥é€š</div>
                            <div class="dropdown-option" data-value="æœªæ¥é€š">æœªæ¥é€š</div>
                            <div class="dropdown-option" data-value="å¿™çº¿">å¿™çº¿</div>
                            <div class="dropdown-option" data-value="æ— äººæ¥å¬">æ— äººæ¥å¬</div>
                        </div>
                        <input type="hidden" id="connect-status" name="connect-status">
                    </div>
                </div>
                <div class="form-item">
                    <label>å®¢æˆ·åç§°</label>
                    <div class="name-input-wrap">
                        <input type="text" id="customer-name" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                </div>
                <div class="form-item">
                    <label>ç”µè¯</label>
                    <input type="tel" id="customer-tel" placeholder="è¯·è¾“å…¥ç”µè¯å·ç " oninput="filterDigitsOnly(this);">
                </div>
            </div>
            <div class="form-right">
                <div class="form-item">
                    <label>å¤‡æ³¨</label>
                    <textarea id="customer-remark" rows="4" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
                </div>
                <div class="form-item">
                    <label>æ‰‹æœº</label>
                    <input type="tel" id="customer-phone" value="18523266916" readonly>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-save">ä¿å­˜</button>
            <button class="btn-cancel">å–æ¶ˆ</button>
        </div>
    </div>
    <script>
        // è¿‡æ»¤æ•°å­—è¾“å…¥
        function filterDigitsOnly(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        let currentIndex = 0;
        let isAutoNext = false;
        const autoNextBtn = document.getElementById('auto-next-btn');
        const currentUser = JSON.parse(localStorage.getItem('crm_user'));
        
        // è·å–URLå‚æ•°ä¸­çš„å®¢æˆ·ID
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('id');
        
        // è·å–å½“å‰ç”¨æˆ·èƒ½çœ‹åˆ°çš„å®¢æˆ·
        function getVisibleCustomers() {
            const savedCustomers = localStorage.getItem('crm_customers');
            const customers = savedCustomers ? JSON.parse(savedCustomers) : [];
            const roleId = currentUser.roleId;
            
            if (roleId === 1) {
                // è¶…çº§ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¢æˆ·
                return customers;
            } else if (roleId === 2) {
                // ç»„å†…ç®¡ç†å‘˜åªèƒ½çœ‹åˆ°æœ¬ç»„å®¢æˆ·
                return customers.filter(c => c.department === currentUser.department);
            } else {
                // ç»„å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±çš„å®¢æˆ·
                return customers.filter(c => c.owner === currentUser.name);
            }
        }
        
        // å¦‚æœæœ‰å®¢æˆ·IDå‚æ•°ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•
        const visibleCustomers = getVisibleCustomers();
        if (customerId) {
            const index = visibleCustomers.findIndex(c => c.id === parseInt(customerId));
            if (index !== -1) {
                currentIndex = index;
            }
        }
        loadCustomerData();
        document.getElementById('prev-btn').addEventListener('click', function() {
            const visibleCustomers = getVisibleCustomers();
            if (currentIndex === 0) {
                // åˆ›å»ºé¡µé¢å†…æç¤º
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff6b6b; color: white; padding: 12px 20px; border-radius: 4px; z-index: 9999; font-size: 14px;';
                toast.textContent = 'å½“å‰å·²ç»æ˜¯ç¬¬ä¸€æ¡æ•°æ®ï¼Œæ— æ³•ç»§ç»­å‘ä¸Šåˆ‡æ¢';
                document.body.appendChild(toast);
                // 3ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
                return;
            }
            currentIndex--;
            loadCustomerData();
        });
        document.getElementById('next-btn').addEventListener('click', function() {
            const visibleCustomers = getVisibleCustomers();
            if (currentIndex === visibleCustomers.length - 1) {
                // åˆ›å»ºé¡µé¢å†…æç¤º
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff6b6b; color: white; padding: 12px 20px; border-radius: 4px; z-index: 9999; font-size: 14px;';
                toast.textContent = 'å½“å‰å·²ç»æ˜¯æœ€åä¸€æ¡æ•°æ®ï¼Œæ— æ³•ç»§ç»­å‘ä¸‹åˆ‡æ¢';
                document.body.appendChild(toast);
                // 3ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
                return;
            }
            currentIndex++;
            loadCustomerData();
        });
        autoNextBtn.addEventListener('click', function() {
            isAutoNext = !isAutoNext;
            this.classList.toggle('active', isAutoNext);
            
            if (isAutoNext) {
                // è‡ªåŠ¨ä¸‹ä¸€æ¡é€»è¾‘
                const autoNextInterval = setInterval(() => {
                    const visibleCustomers = getVisibleCustomers();
                    if (currentIndex < visibleCustomers.length - 1) {
                        currentIndex++;
                        loadCustomerData();
                    } else {
                        // å·²ç»åˆ°è¾¾æœ€åä¸€æ¡ï¼Œåœæ­¢è‡ªåŠ¨åˆ‡æ¢
                        isAutoNext = false;
                        this.classList.remove('active');
                        clearInterval(autoNextInterval);
                    }
                }, 3000); // æ¯3ç§’è‡ªåŠ¨åˆ‡æ¢
            }
        });
        function loadCustomerData() {
            const visibleCustomers = getVisibleCustomers();
            const customer = visibleCustomers[currentIndex];
            
            if (customer) {
                document.getElementById('customer-level').value = customer.customerLevel || 'c';
                document.getElementById('connect-status').value = customer.callStatus || 'unconnected';
                document.getElementById('customer-name').value = customer.name || '';
                document.getElementById('customer-tel').value = customer.phone || '';
                document.getElementById('customer-remark').value = customer.remark || '';
            } else {
                // å¦‚æœæ²¡æœ‰å®¢æˆ·æ•°æ®ï¼Œæ¸…ç©ºè¡¨å•å¹¶æ˜¾ç¤ºæç¤º
                document.getElementById('customer-level').value = 'c';
                document.getElementById('connect-status').value = 'unconnected';
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-tel').value = '';
                document.getElementById('customer-remark').value = '';
                
                // åˆ›å»ºé¡µé¢å†…æç¤º
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff6b6b; color: white; padding: 12px 20px; border-radius: 4px; z-index: 9999; font-size: 14px;';
                toast.textContent = 'æ²¡æœ‰æ‰¾åˆ°æ‚¨å¯ä»¥ç¼–è¾‘çš„å®¢æˆ·æ•°æ®';
                document.body.appendChild(toast);
                // 3ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            }
        }
        // ä¸‹æ‹‰èœå•äº¤äº’é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // å®¢æˆ·çº§åˆ«ä¸‹æ‹‰èœå•
            const levelTrigger = document.getElementById('level-trigger');
            const levelOptions = document.getElementById('level-options');
            const levelDisplay = document.getElementById('level-display');
            const customerLevel = document.getElementById('customer-level');
            
            // æ¥é€šçŠ¶æ€ä¸‹æ‹‰èœå•
            const statusTrigger = document.getElementById('status-trigger');
            const statusOptions = document.getElementById('status-options');
            const statusDisplay = document.getElementById('status-display');
            const connectStatus = document.getElementById('connect-status');
            
            // å®¢æˆ·çº§åˆ«ä¸‹æ‹‰èœå•äº¤äº’
            if (levelTrigger && levelOptions && levelDisplay && customerLevel) {
                levelTrigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    levelOptions.classList.toggle('show');
                });
                
                document.querySelectorAll('#level-options .dropdown-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const value = option.getAttribute('data-value');
                        const text = option.textContent;
                        levelDisplay.textContent = text;
                        customerLevel.value = value;
                        levelOptions.classList.remove('show');
                    });
                });
            }
            
            // æ¥é€šçŠ¶æ€ä¸‹æ‹‰èœå•äº¤äº’
            if (statusTrigger && statusOptions && statusDisplay && connectStatus) {
                statusTrigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    statusOptions.classList.toggle('show');
                });
                
                document.querySelectorAll('#status-options .dropdown-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const value = option.getAttribute('data-value');
                        const text = option.textContent;
                        statusDisplay.textContent = text;
                        connectStatus.value = value;
                        statusOptions.classList.remove('show');
                    });
                });
            }
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', (e) => {
                const isLevelTrigger = e.target.closest('#level-trigger') || e.target.closest('#level-options');
                const isStatusTrigger = e.target.closest('#status-trigger') || e.target.closest('#status-options');
                
                if (levelOptions && !isLevelTrigger) {
                    levelOptions.classList.remove('show');
                }
                if (statusOptions && !isStatusTrigger) {
                    statusOptions.classList.remove('show');
                }
            });
        });
        
        document.querySelector('.btn-save').addEventListener('click', function() {
            const level = document.getElementById('customer-level').value;
            const status = document.getElementById('connect-status').value;
            const name = document.getElementById('customer-name').value;
            const tel = document.getElementById('customer-tel').value;
            const remark = document.getElementById('customer-remark').value;
            const phone = document.getElementById('customer-phone').value;
            
            // éªŒè¯æ‰‹æœºå·ç å¿…é¡»ä¸ºæ•°å­—ä¸”è‡³å°‘11ä½
            const phoneRegex = /^\d{11,}$/;
            if (!phoneRegex.test(phone)) {
                alert('æ‰‹æœºå·ç å¿…é¡»ä¸ºæ•°å­—ä¸”è‡³å°‘11ä½');
                return;
            }
            
            // éªŒè¯æ¥é€šçŠ¶æ€å’Œå®¢æˆ·çº§åˆ«æ˜¯å¦æœ‰æ•ˆ
            const validCallStatuses = ['å·²æ¥é€š', 'æœªæ¥é€š', 'å¿™çº¿', 'æ— äººæ¥å¬'];
            const validCustomerLevels = ['A', 'B', 'C'];
            let isValid = true;
            
            // éªŒè¯æ¥é€šçŠ¶æ€
            if (status && !validCallStatuses.includes(status)) {
                alert('æ¥é€šçŠ¶æ€æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©');
                document.getElementById('connect-status').value = '';
                document.getElementById('status-display').textContent = 'è¯·é€‰æ‹©æ¥é€šçŠ¶æ€';
                isValid = false;
            }
            
            // éªŒè¯å®¢æˆ·çº§åˆ«
            if (level && !validCustomerLevels.includes(level)) {
                alert('å®¢æˆ·çº§åˆ«æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©');
                document.getElementById('customer-level').value = '';
                document.getElementById('level-display').textContent = 'è¯·é€‰æ‹©å®¢æˆ·çº§åˆ«';
                isValid = false;
            }
            
            // å¦‚æœæœ‰ä»»ä½•éªŒè¯å¤±è´¥ï¼Œé˜»æ­¢æäº¤
            if (!isValid) {
                return;
            }
            
            const currentData = {
                level,
                status,
                name,
                tel,
                remark,
                phone
            };
            if (isAutoNext) {
                currentIndex++;
                loadCustomerData();
            }
        });
        document.querySelector('.btn-cancel').addEventListener('click', function() {
            loadCustomerData();
        });
        document.querySelector('.modal-close').addEventListener('click', function() {
        });
    </script>
</body>
</html>